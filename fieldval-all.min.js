function extend(e,t){function r(){}r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e,e.superConstructor=t,e.superClass=t.prototype}function FVRuleField(e,t){var r=this;if(r.json=e,r.checks=[],r.validator="undefined"!=typeof t?t:new FieldVal(e),r.name=r.validator.get("name",BasicVal.string(!1)),r.display_name=r.validator.get("display_name",BasicVal.string(!1)),r.description=r.validator.get("description",BasicVal.string(!1)),r.type=r.validator.get("type",BasicVal.string(!0)),r.required=r.validator.default_value(!0).get("required",BasicVal["boolean"](!1)),null!=e){var i=r.validator.get("exists",BasicVal["boolean"](!1));null!=i&&(existsFilter=i?1:2)}}function FVBasicRuleField(e,t){FVBasicRuleField.superConstructor.call(this,e,t)}function FVTextRuleField(e,t){FVTextRuleField.superConstructor.call(this,e,t)}function FVNumberRuleField(e,t){FVNumberRuleField.superConstructor.call(this,e,t)}function FVObjectRuleField(e,t){FVObjectRuleField.superConstructor.call(this,e,t)}function FVArrayRuleField(e,t){var r=this;FVArrayRuleField.superConstructor.call(this,e,t),r.rules=[],r.fields=[],r.interval=null,r.interval_offsets=[]}function FVChoiceRuleField(e,t){FVChoiceRuleField.superConstructor.call(this,e,t)}function FVBooleanRuleField(e,t){FVBooleanRuleField.superConstructor.call(this,e,t)}function FVEmailRuleField(e,t){FVEmailRuleField.superConstructor.call(this,e,t)}function FVRule(){}function fieldval_ui_extend(e,t){function r(){}r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e,e.superConstructor=t,e.superClass=t.prototype}function FVField(e,t){var r=this;r.name=e,r.options=t||{},r.output_flag=!0,r.is_in_array=!1,r.key_value_parent=null,r.is_in_key_value=!1,r.is_disabled=!1,r.on_change_callbacks=[],r.element=$("<div />").addClass("fv_field").data("field",r),r.title=$("<div />").addClass("fv_field_title").text(r.name),r.name||r.title.hide(),r.options.description&&(r.description_label=$("<div />").addClass("fv_field_description").text(r.options.description)),r.input_holder=$("<div />").addClass("fv_input_holder"),r.error_message=$("<div />").addClass("fv_error_message").hide(),r.layout()}function FVTextField(e,t){var r=this,i=typeof t;"string"===i?(r.input_type=t,t={}):"object"===i?r.input_type=t.type||"text":t={},FVTextField.superConstructor.call(this,e,t),r.element.addClass("fv_text_field"),r.input=$("textarea"===r.input_type?"<textarea />":"text"!==r.input_type&&"number"!==r.input_type&&r.input_type?"<input type='"+r.input_type+"' />":"<input type='text' />"),r.enter_callbacks=[],r.previous_value={},r.input.addClass("fv_text_input").attr("placeholder",e).on("keydown",function(e){if(13===e.keyCode)for(var t=0;t<r.enter_callbacks.length;t++)r.enter_callbacks[t](e)}).on("keyup paste cut",function(){setTimeout(function(){r.check_changed()},0)}).appendTo(r.input_holder)}function FVPasswordField(e){FVPasswordField.superConstructor.call(this,e,{type:"password"})}function FVDisplayField(e,t){var r=this;FVDisplayField.superConstructor.call(this,e,t),r.element.addClass("fv_display_field"),r.input=$("<div />").appendTo(r.input_holder),r.output_flag=!1}function FVChoiceField(e,t){var r=this;FVChoiceField.superConstructor.call(this,e,t),r.choices=r.options.choices||[],r.allow_empty=r.options.allow_empty||!1,r.empty_text=r.options.empty_text||"",r.choice_values=[],r.choice_texts=[],r.selected_value=null,r.allow_empty&&(r.choice_values.push(null),r.choice_texts.push(r.empty_text));for(var i=0;i<r.choices.length;i++){var n,l,a=r.choices[i];"object"==typeof a?(n=a[0],l=a[1]):n=l=a,r.choice_values.push(n),r.choice_texts.push(l)}r.element.addClass("fv_choice_field"),r.select=$("<div/>").append(r.filter_input=$("<input type='text' />").attr("placeholder",e).addClass("filter_input"),r.current_display=$("<div />").addClass("fv_choice_display fv_choice_placeholder").on(FVForm.button_event,function(){r.focus()}).text(r.name),r.choice_list=$("<div />").addClass("fv_choice_list").bind("mousewheel DOMMouseScroll",function(e){var t=null;"mousewheel"==e.type?t=e.originalEvent.wheelDelta*-.5:"DOMMouseScroll"==e.type&&(t=40*e.originalEvent.detail),t&&(e.preventDefault(),$(this).scrollTop(t+$(this).scrollTop()))})).addClass("fv_choice_input").appendTo(r.input_holder),r.filter_input.hide().on("keydown",function(e){r.filter_key_down(e)}).on("keyup",function(e){r.filter_key_up(e)}),$("html").on(FVForm.button_event,function(e){r.filter_input.is(":visible")&&($(e.target).closest(r.filter_input).length||r.hide_list())}),r.filter("")}function FVDateField(e,t){var r=this;if("undefined"==typeof DateVal)return void console.error("FVDateField requires fieldval-dateval-js");FVDateField.superConstructor.call(this,e,t),r.element.addClass("fv_date_field"),r.format_string=r.options.format||"yyyy-MM-dd";var i=DateVal.date_format().check(r.format_string,function(e){r.format_array=e});if(i)return void console.error(i.error_message);r.inputs=[];for(var n=0;n<r.format_array.length;n++){var l=r.format_array[n],a=DateVal.date_components[l];r.add_element_from_component(l,a)}}function FVBooleanField(e,t){var r=this;FVBooleanField.superConstructor.call(this,e,t),r.element.addClass("fv_boolean_field"),r.input=$("<input type='checkbox' />").addClass("fv_boolean_input").on("change",function(){r.did_change()}).appendTo(r.input_holder)}function FVObjectField(e,t){var r=this;FVObjectField.superConstructor.call(this,e,t),r.element.addClass("fv_object_field"),r.fields_element=r.input_holder,r.fields={}}function FVArrayField(e,t){var r=this;FVArrayField.superConstructor.call(this,e,t),r.fields=[],r.add_button_text=void 0!==r.options.add_button_text?r.options.add_button_text:"+",r.add_field_buttons=[],r.element.addClass("fv_array_field"),r.input_holder.append(r.fields_element=$("<div />").addClass("fv_nested_fields"),r.create_add_field_button()),r.fields_element.nestable({rootClass:"fv_nested_fields",itemClass:"fv_field",handleClass:"fv_field_move_handle",itemNodeName:"div.fv_field",listNodeName:"div.fv_nested_fields",threshold:40}).on("change",function(){r.reorder()})}function FVKeyValueField(e,t){var r=this;FVKeyValueField.superConstructor.call(this,e,t),r.fields=[],r.keys={},r.add_field_buttons=[],r.element.addClass("fv_key_value_field"),r.input_holder.append(r.fields_element=$("<div />").addClass("fv_nested_fields"),r.create_add_field_button())}function FVForm(){var e=this;FVForm.superConstructor.call(this);var t=e.element.children();e.element.remove(),e.element=$("<form />").addClass("fv_form").append(t),e.element.on("submit",function(t){return t.preventDefault(),e.submit(),!1}),e.fields_element=e.element,e.submit_callbacks=[]}var FieldVal=function(){"use strict";function e(t,r){var i=this;if(i.async_waiting=0,i.validating=t,i.missing_keys={},i.invalid_keys={},i.unrecognized_keys={},i.recognized_keys={},i.errors=[],void 0!==r)if(r){var n;if(r.error===e.ONE_OR_MORE_ERRORS)n=r;else if(r.error===e.MULTIPLE_ERRORS)for(var l=0;l<r.errors.length;l++){var a=r.errors[l];0!==a.error?i.errors.push(a):n=a}else i.errors.push(r);if(n){for(var o in t)t.hasOwnProperty(o)&&(i.recognized_keys[o]=!0);if(n.missing&&(i.missing_keys=n.missing),n.unrecognized){i.unrecognized_keys=n.unrecognized;for(var s in i.unrecognized_keys)i.unrecognized_keys.hasOwnProperty(s)&&delete i.recognized_keys[s]}n.invalid&&(i.invalid_keys=n.invalid)}}else for(var o in t)t.hasOwnProperty(o)&&(i.recognized_keys[o]=!0)}Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)});var t=function(e){var t;for(t in e)if(e.hasOwnProperty(t))return!1;return!0};return e.prototype.dig=function(){var t,r=this,i=arguments[0];t=Array.isArray(i)?i:arguments;for(var n=r.validating,l=r,a=0;a<t.length;a++){var o=t[a];if(n=n[o],void 0===n)return void 0;if(l){var s;s=l instanceof e?l.invalid_keys:l.invalid,s&&(l=s[o])}}return new e(n,l)},e.prototype.invalid=function(){var t,r,i=this,n=arguments[arguments.length-1];if(2===arguments.length){var l=arguments[0];if(!Array.isArray(l))return i.invalid_keys[arguments[0]]=e.add_to_invalid(n,i.invalid_keys[arguments[0]]),i;t=l,r=l.length}else t=arguments,r=arguments.length-1;for(var a=i,o=0;r>o;o++){var s,d=t[o];s=a instanceof e?a.invalid_keys:a.invalid;var u;u=o===r-1?n:s[d],u||(u={error:e.ONE_OR_MORE_ERRORS,error_message:e.ONE_OR_MORE_ERRORS_STRING,invalid:{}}),a instanceof e?a.invalid(d,u):s[d]=e.add_to_invalid(u,s[d]),a=u}return i},e.prototype.default_value=function(e){var t=this;return{get:function(){var r=t.get.apply(t,arguments);return void 0!==r?r:e}}},e.prototype.get=function(t){var r,i=this,n=Array.prototype.slice.call(arguments,1),l=!1,a=i.get_async(t,n,function(e){l=!0,r=e});if(a===e.ASYNC)throw new Error(".get used with async checks, use .get_async.");return r},e.prototype.get_async=function(t,r,i){var n=this;if(!Array.isArray(r))throw new Error(".get_async second argument must be an array of checks");var l=n.validating[t];n.recognized_keys[t]=!0;var a=e.use_checks(l,r,{validator:n,field_name:t,emit:function(e){l=e}},function(){void 0!==i&&i(l)});return a===e.ASYNC?e.ASYNC:void 0},e.prototype.error=function(e){var t=this;return t.errors.push(e),t},e.add_to_invalid=function(t,r){if(void 0!==r){if(void 0!==r.errors){for(var i=0;i<r.errors.length;i++){var n=r.errors;void 0!==n.error&&n.error===t.error&&(r.errors[i]=t)}r.errors.push(t)}else r=void 0!==r.error&&r.error===t.error?t:{error:e.MULTIPLE_ERRORS,error_message:"Multiple errors.",errors:[r,t]};return r}return t},e.prototype.missing=function(t,r){var i=this;return i.missing_keys[t]=e.create_error(e.MISSING_ERROR,r),i},e.prototype.unrecognized=function(t){var r=this;return r.unrecognized_keys[t]={error_message:"Unrecognized field.",error:e.FIELD_UNRECOGNIZED},r},e.prototype.recognized=function(e){var t=this;return t.recognized_keys[e]=!0,t},e.prototype.get_unrecognized=function(){var e,t=this,r=[];for(e in t.validating)t.validating.hasOwnProperty(e)&&t.recognized_keys[e]!==!0&&r.push(e);return r},e.prototype.async_call_ended=function(){var e=this;e.async_waiting--,e.async_waiting<=0&&e.end_callback&&e.end_callback(e.generate_response(),e.recognized_keys)},e.prototype.generate_response=function(){var r,i=this,n={},l=!1,a={};for(r in i.unrecognized_keys)i.unrecognized_keys.hasOwnProperty(r)&&(a[r]=i.unrecognized_keys[r]);var o,s,d=i.get_unrecognized();for(o=0;o<d.length;o++)s=d[o],a[s]||(a[s]={error_message:"Unrecognized field.",error:e.FIELD_UNRECOGNIZED});if(t(i.missing_keys)||(n.missing=i.missing_keys,l=!0),t(i.invalid_keys)||(n.invalid=i.invalid_keys,l=!0),t(a)||(n.unrecognized=a,l=!0),l){if(n.error_message=e.ONE_OR_MORE_ERRORS_STRING,n.error=e.ONE_OR_MORE_ERRORS,0===i.errors.length)return n;i.errors.push(n)}return 0!==i.errors.length?1===i.errors.length?i.errors[0]:{error:e.MULTIPLE_ERRORS,error_message:"Multiple errors.",errors:i.errors}:null},e.prototype.end=function(e){var t=this;return e?(t.end_callback=e,void(t.async_waiting<=0&&e(t.generate_response(),t.recognized_keys))):t.generate_response()},e.prototype.end_with_recognized=function(e){var t=this;if(e)t.end(e);else if(t.async_waiting>0)return[t.generate_response(),t.recognized_keys]},e.ASYNC=-1,e.REQUIRED_ERROR=Math.sqrt,e.NOT_REQUIRED_BUT_MISSING=Math.floor,e.ONE_OR_MORE_ERRORS=0,e.ONE_OR_MORE_ERRORS_STRING="One or more errors.",e.FIELD_MISSING=1,e.INCORRECT_FIELD_TYPE=2,e.FIELD_UNRECOGNIZED=3,e.MULTIPLE_ERRORS=4,e.INCORRECT_TYPE_ERROR=function(t,r){return{error_message:"Incorrect field type. Expected "+t+".",error:e.INCORRECT_FIELD_TYPE,expected:t,received:r}},e.MISSING_ERROR=function(){return{error_message:"Field missing.",error:e.FIELD_MISSING}},e.get_value_and_type=function(e,t,r){r||(r={});var i=void 0!==r.parse?r.parse:!1;if("string"!=typeof e||i)if("integer"===t){var n=parseInt(e,10);isNaN(n)||n.toString().length!==e.toString().length||(e=n,t=n,t="number")}else if("float"===t||"number"===t){var l=parseFloat(e,10);isNaN(l)||l.toString().length!==e.toString().length||(e=l,t="number")}else"boolean"===t&&("true"===e&&(e=!0),"false"===e&&(e=!1));var a=typeof e;return"object"===a&&Array.isArray(e)&&(a="array"),{type:a,desired_type:t,value:e}},e.use_check=function(t,r,i){var n,l=!0,a={},o=0;if("object"==typeof t){if(Array.isArray(t)){var s=!1,d=t,u=!1,c=function(){if(o++,r.stop||o>d.length)return u=!0,void i();var t=e.use_check(d[o-1],r,function(){c()});t===e.ASYNC&&(s=!0)};return c(),u?s?e.ASYNC:void 0:e.ASYNC}a=t,n=a.check,a&&void 0!==a.stop_on_error&&(l=a.stop_on_error)}else{if("function"!=typeof t)throw new Error("A check can only be provided as a function or as an object with a function as the .check property.");n=t,l=!0}var f=function(t){if(null!==t&&void 0!==t){if(l&&(r.stop=!0),r.had_error=!0,t===e.REQUIRED_ERROR)return void 0!==r.field_name?(r.validator.missing(r.field_name,a),void i()):r.existing_validator?(r.validator.error(e.create_error(e.MISSING_ERROR,a)),void i()):(r.return_missing=!0,void i());t===e.NOT_REQUIRED_BUT_MISSING?i():r.existing_validator?(void 0!==r.field_name?r.validator.invalid(r.field_name,t):r.validator.error(t),i()):(r.validator.error(t),i())}else i()},p=n(r.value,r.emit,function(e){f(e)});return 3===n.length?e.ASYNC:(f(p),null)},e.use_checks=function(t,r,i,n){"function"==typeof i&&(n=i,i=void 0),i||(i={});var l={value:t,field_name:i.field_name,emit:function(e){l.value=e},options:i,stop:!1,return_missing:!1,had_error:!1};i.validator?(l.validator=i.validator,l.existing_validator=!0):l.validator=new e;var a,o=!1,s=function(e){a=e,o=!0,n&&n(e)};l.validator.async_waiting++;var d=e.use_check(r||[],l,function(){return l.had_error?l.options.emit&&l.options.emit(void 0):l.options.emit&&l.options.emit(l.value),l.return_missing?(s(e.REQUIRED_ERROR),void l.validator.async_call_ended()):l.existing_validator?(s(null),void l.validator.async_call_ended()):(s(l.validator.end()),void l.validator.async_call_ended())});return d===e.ASYNC?(n&&(s=n),e.ASYNC):o?a:e.ASYNC},e.required=function(t,r){var i=function(r){return null===r||void 0===r?t||void 0===t?e.REQUIRED_ERROR:e.NOT_REQUIRED_BUT_MISSING:void 0};return void 0!==r?(r.check=i,r):i},e.type=function(t,r){var i=r&&void 0!==r.required?r.required:!0,n=function(n,l){var a=e.required(i)(n);if(a)return a;var o=e.get_value_and_type(n,t,r),s=o.desired_type,d=o.type;return n=o.value,d!==s?e.create_error(e.INCORRECT_TYPE_ERROR,r,s,d):void(l&&l(n))};return void 0!==r?(r.check=n,r):n},e.create_error=function(t,r){if(!r)return t.apply(null,Array.prototype.slice.call(arguments,2));if(t===e.MISSING_ERROR){var i=typeof r.missing_error;if("function"===i)return r.missing_error.apply(null,Array.prototype.slice.call(arguments,2));if("object"===i)return r.missing_error;if("string"===i)return{error_message:r.missing_error}}else{var n=typeof r.error;if("function"===n)return r.error.apply(null,Array.prototype.slice.call(arguments,2));if("object"===n)return r.error;if("string"===n)return{error_message:r.error}}return t.apply(null,Array.prototype.slice.call(arguments,2))},e}.call();"undefined"!=typeof module&&(module.exports=FieldVal);var BasicVal=function(){"function"==typeof require&&(FieldVal=require("fieldval")),Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){var r;if(null===this)throw new TypeError('"this" is null or not defined');var i=Object(this),n=i.length>>>0;if(0===n)return-1;var l=+t||0;if(1/0===Math.abs(l)&&(l=0),l>=n)return-1;for(r=Math.max(l>=0?l:n-Math.abs(l),0);n>r;){if(r in i&&i[r]===e)return r;r++}return-1});var e={errors:{too_short:function(e){return{error:100,error_message:"Length is less than "+e}},too_long:function(e){return{error:101,error_message:"Length is greater than "+e}},too_small:function(e){return{error:102,error_message:"Value is less than "+e}},too_large:function(e){return{error:103,error_message:"Value is greater than "+e}},not_in_list:function(){return{error:104,error_message:"Value is not a valid choice"}},cannot_be_empty:function(){return{error:105,error_message:"Value cannot be empty."}},no_prefix:function(e){return{error:106,error_message:"Value does not have prefix: "+e}},invalid_email:function(){return{error:107,error_message:"Invalid email address format."}},invalid_url:function(){return{error:108,error_message:"Invalid url format."}},incorrect_length:function(e){return{error:109,error_message:"Length is not equal to "+e}},no_suffix:function(e){return{error:110,error_message:"Value does not have suffix: "+e}},not_equal:function(e){return{error:113,error_message:"Not equal to "+e+"."}},no_valid_option:function(){return{error:115,error_message:"None of the options were valid."}},contains_whitespace:function(){return{error:116,error_message:"Contains whitespace."}},must_start_with_letter:function(){return{error:117,error_message:"Must start with a letter."}},value_in_list:function(){return{error:104,error_message:"Value not allowed"}},should_not_contain:function(e){var t=e.join(",");return{error:105,error_message:"Cannot contain "+t}}},equal_to:function(t,r){var i=function(i){return i!==t?FieldVal.create_error(e.errors.not_equal,r,t):void 0};return r?(r.check=i,r):{check:i}},merge_required_and_flags:function(e,t){return"object"==typeof e?t=e:(t||(t={}),t.required=e),t},integer:function(t,r){return FieldVal.type("integer",e.merge_required_and_flags(t,r))},number:function(t,r){return FieldVal.type("number",e.merge_required_and_flags(t,r))},array:function(t,r){return FieldVal.type("array",e.merge_required_and_flags(t,r))},object:function(t,r){return FieldVal.type("object",e.merge_required_and_flags(t,r))},"float":function(t,r){return FieldVal.type("float",e.merge_required_and_flags(t,r))},"boolean":function(t,r){return FieldVal.type("boolean",e.merge_required_and_flags(t,r))},string:function(t,r){r=e.merge_required_and_flags(t,r);var i=function(e,i){var n=FieldVal.type("string",r);"object"==typeof n&&(n=n.check);var l=n(e,i);return l?l:(r&&r.trim===!1||(e=e.trim()),0===e.length?t||void 0===t?FieldVal.REQUIRED_ERROR:FieldVal.NOT_REQUIRED_BUT_MISSING:void 0)};return r?(r.check=i,r):{check:i}},length:function(t,r){var i=function(i){return i.length!==t?FieldVal.create_error(e.errors.incorrect_length,r,t):void 0};return r?(r.check=i,r):{check:i}},min_length:function(t,r){var i=function(i){return i.length<t?FieldVal.create_error(e.errors.too_short,r,t):void 0};return r?(r.check=i,r):{check:i}},max_length:function(t,r){var i=function(i){return i.length>t?FieldVal.create_error(e.errors.too_long,r,t):void 0};return r?(r.check=i,r):{check:i}},no_whitespace:function(t){var r=function(r){return/\s/.test(r)?FieldVal.create_error(e.errors.contains_whitespace,t,max_len):void 0};return t?(t.check=r,t):{check:r}},minimum:function(t,r){var i=function(i){return t>i?FieldVal.create_error(e.errors.too_small,r,t):void 0};return r?(r.check=i,r):{check:i}},maximum:function(t,r){var i=function(i){return i>t?FieldVal.create_error(e.errors.too_large,r,t):void 0};return r?(r.check=i,r):{check:i}},range:function(t,r,i){var n=function(n){return t>n?FieldVal.create_error(e.errors.too_small,i,t):n>r?FieldVal.create_error(e.errors.too_large,i,r):void 0};return i?(i.check=n,i):{check:n}},does_not_contain:function(t,r){Array.isArray(t)||(t=[t]);var i=function(i){for(var n=0;n<t.length;n++)if(-1!==i.indexOf(t[n]))return FieldVal.create_error(e.errors.should_not_contain,r,t)};return r?(r.check=i,r):{check:i}},one_of:function(t,r){var i=[];if(Array.isArray(t))for(var n=0;n<t.length;n++){var l=t[n];i.push("object"==typeof l?l[0]:l)}else for(var a in t)t.hasOwnProperty(a)&&i.push(a);var o=function(t){return-1===i.indexOf(t)?FieldVal.create_error(e.errors.not_in_list,r):void 0};return r?(r.check=o,r):{check:o}},not_one_of:function(t,r){var i=[];if("[object Array]"===Object.prototype.toString.call(t))for(var n=0;n<t.length;n++){var l=t[n];i.push("object"==typeof l?l[0]:l)}else for(var a in t)t.hasOwnProperty(a)&&i.push(a);var o=function(t){return-1!==i.indexOf(t)?FieldVal.create_error(e.errors.value_in_list,r):void 0};return r?(r.check=o,r):{check:o}},not_empty:function(t,r){var i=function(i){if(t){if(0===i.trim().length)return FieldVal.create_error(e.errors.cannot_be_empty,r)}else if(0===i.length)return FieldVal.create_error(e.errors.cannot_be_empty,r)};return r?(r.check=i,r):{check:i}},prefix:function(t,r){var i=function(i){return i.length>=t.length?i.substring(0,t.length)!=t?FieldVal.create_error(e.errors.no_prefix,r,t):void 0:FieldVal.create_error(e.errors.no_prefix,r,t)};return r?(r.check=i,r):{check:i}},start_with_letter:function(t){var r=function(r){if(!(r.length>0))return FieldVal.create_error(e.errors.must_start_with_letter,t);var i=r.charCodeAt(0);return i>=65&&90>=i||i>=97&&122>=i?void 0:FieldVal.create_error(e.errors.must_start_with_letter,t)};return t?(t.check=r,t):{check:r}},suffix:function(t,r){var i=function(i){return i.length>=t.length?i.substring(i.length-t.length,i.length)!=t?FieldVal.create_error(e.errors.no_suffix,r,t):void 0:FieldVal.create_error(e.errors.no_suffix,r,t)};return r?(r.check=i,r):{check:i}},each:function(e,t){var r=function(t){var r=new FieldVal(null),i=function(i){var n=t[i],l=e(n,i,function(e){t[i]=e});if(l===FieldVal.ASYNC)throw new Error(".each used with async checks, use .each_async.");l===FieldVal.REQUIRED_ERROR?r.missing(""+i):l&&r.invalid(""+i,l)};if(Array.isArray(t))for(var n=0;n<t.length;n++)i(n);else for(var l in t)t.hasOwnProperty(l)&&i(l);var a=r.end();return a?a:void 0};return t?(t.check=r,t):{check:r}},each_async:function(e,t){var r=function(t,r,i){var n,l=Array.isArray(t);l||(n=Object.keys(t));var a,o,s=new FieldVal(null),d=0;l&&(a=d);var u=function(){if(l){if(a++,a>t.length)return void i(s.end());o=t[a-1]}else{if(d++,d>n.length)return void i(s.end());a=n[d-1],o=t[a]}FieldVal.use_checks(o,[function(t,r,i){e(t,a,r,i)}],{field_name:l?""+(a-1):a,validator:s,emit:function(e){l?t[a-1]=e:t[a]=e}},function(){u()})};u()};return t?(t.check=r,t):{check:r}},multiple:function(t,r){t=t||[],0===t.length&&console.error("BasicVal.multiple called without possibles.");var i=function(i,n){for(var l=0;l<t.length;l++){var a,o=t[l],s=FieldVal.use_checks(i,o,null,null,function(e){a=e});if(s===FieldVal.ASYNC)throw new Error(".multiple used with async checks, use .multiple_async.");if(!s)return void 0!==a&&n(a),null}return FieldVal.create_error(e.errors.no_valid_option,r)};return r?(r.check=i,r):{check:i}},multiple_async:function(t,r){if(t=t||[],0===t.length)return void console.error("BasicVal.multiple_async called without possibles.");var i,n=function(n,l,a){var o,s=function(e){o=e},d=0,u=function(){if(d++,d>t.length)return void a(FieldVal.create_error(e.errors.no_valid_option,r));var i=t[d-1];FieldVal.use_checks(n,i,{field_name:null,validator:null,emit:s},function(e){e?u():a(void 0)})};return u(),i};return r?(r.check=n,r):{check:n}},email:function(t){var r=function(r){var i=e.email_regex;return i.test(r)?void 0:FieldVal.create_error(e.errors.invalid_email,t)};return t?(t.check=r,t):{check:r}},url:function(t){var r=function(r){var i=e.url_regex;return i.test(r)?void 0:FieldVal.create_error(e.errors.invalid_url,t)};return t?(t.check=r,t):{check:r}}};return e.email_regex=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,e.url_regex=/^(https?):\/\/(((([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5]))|((([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])))(:[1-9][0-9]+)?(\/)?([\/?].+)?$/,e}.call();"undefined"!=typeof module&&(module.exports=BasicVal),"function"==typeof require&&(FieldVal=require("fieldval"),BasicVal=require("fieldval-basicval"));var DateVal={errors:{invalid_date_format:function(){return{error:111,error_message:"Invalid date format."}},invalid_date:function(){return{error:112,error_message:"Invalid date."}},invalid_date_format_string:function(){return{error:114,error_message:"Invalid date format string."}}},date_format:function(e){var t=function(t,r){for(var i=[],n=0,l=!1;n<t.length&&!l;){var a=!1;for(var o in DateVal.date_components){var s=t.substring(n,n+o.length);if(s===o){i.push(o),n+=o.length,a=!0;break}}a||(l=!0)}return l?FieldVal.create_error(DateVal.errors.invalid_date_format_string,e):void r(i)};return e?(e.check=t,e):{check:t}},date_with_format_array:function(e,t){for(var r="",i=0;i<t.length;i++){var n=t[i],l=DateVal.date_components[n];if(0===l)r+=n;else{var a;"yyyy"===n?a=e.getUTCFullYear():"yy"===n?a=e.getUTCFullYear().toString().substring(2):"MM"===n||"M"===n?a=e.getUTCMonth()+1:"dd"===n||"d"===n?a=e.getUTCDate():"hh"===n||"h"===n?a=e.getUTCHours():"mm"===n||"m"===n?a=e.getUTCMinutes():("ss"===n||"s"===n)&&(a=e.getUTCSeconds()),r+=DateVal.pad_to_valid(a.toString(),l)}}return r},pad_to_valid:function(e,t){for(var r=0;r<t.length;r++){var i=t[r];if(e.length<=i){for(var n=i-e.length,l=0;n>l;l++)e="0"+e;return e}}return e},date:function(e,t){t=t||{};var r,i=DateVal.date_format().check(e,function(e){r=e});i&&console.error&&console.error(i.error_message);var n=function(e,i){for(var n={},l=[],a=0,o=null,s=null,d=-1,u=!1;a<e.length&&!u;)if(d++,o=r[d],s=DateVal.date_components[o],0!==s){for(var c=s[0],f=s[s.length-1],p="",_=0;f>_;_++){var h=e[a+_];if(void 0===h)break;var v=h.charCodeAt(0);if(48>v||v>57){if(_===c)break;u=!0;break}p+=h}if(a+=_,u)break;var F=parseInt(p);l.push(p),"yyyy"===o||"yy"===o?n.year=F:"MM"===o||"M"===o?n.month=F:"dd"===o||"d"===o?n.day=F:"hh"===o||"h"===o?n.hour=F:"mm"===o||"m"===o?n.minute=F:("ss"===o||"s"===o)&&(n.second=F)}else{if(e[a]!==o){u=!0;break}l.push(null),a++}if(u)return FieldVal.create_error(DateVal.errors.invalid_date_format,t);if(void 0!==n.hour&&(n.hour<0||n.hour>23))return FieldVal.create_error(DateVal.errors.invalid_date,t);if(void 0!==n.minute&&(n.minute<0||n.minute>59))return FieldVal.create_error(DateVal.errors.invalid_date,t);if(void 0!==n.second&&(n.second<0||n.second>59))return FieldVal.create_error(DateVal.errors.invalid_date,t);if(void 0!==n.month){var m=n.month;if(m>12)return FieldVal.create_error(DateVal.errors.invalid_date,t);if(1>m)return FieldVal.create_error(DateVal.errors.invalid_date,t);if(n.day){var g=n.day;if(1>g)return FieldVal.create_error(DateVal.errors.invalid_date,t);if(n.year){var y=n.year;if(2==m)if(y%400===0||y%100!==0&&y%4===0){if(g>29)return FieldVal.create_error(DateVal.errors.invalid_date,t)}else if(g>28)return FieldVal.create_error(DateVal.errors.invalid_date,t)}if(4===m||6===m||9===m||11===m){if(g>30)return FieldVal.create_error(DateVal.errors.invalid_date,t)}else if(2===m){if(g>29)return FieldVal.create_error(DateVal.errors.invalid_date,t)}else if(g>31)return FieldVal.create_error(DateVal.errors.invalid_date,t)}}else if(n.day){if(n.day>31)return FieldVal.create_error(DateVal.errors.invalid_date,t);if(n.day<1)return FieldVal.create_error(DateVal.errors.invalid_date,t)}if(t.emit)if(t.emit===DateVal.EMIT_COMPONENT_ARRAY)i(l);else if(t.emit===DateVal.EMIT_OBJECT)i(n);else if(t.emit===DateVal.EMIT_DATE){var V=new Date(0);V.setUTCFullYear(0),void 0!==n.year&&V.setYear(n.year),void 0!==n.month&&V.setUTCMonth(n.month-1),void 0!==n.day&&V.setUTCDate(n.day),void 0!==n.hour&&V.setUTCHours(n.hour),void 0!==n.minute&&V.setUTCMinutes(n.minute),void 0!==n.second&&V.setUTCSeconds(n.second),i(V)}};return t?(t.check=n,t):{check:n}}};DateVal.EMIT_COMPONENT_ARRAY={},DateVal.EMIT_DATE={},DateVal.EMIT_OBJECT={},DateVal.date_components={yyyy:[4],yy:[2],MM:[2],M:[1,2],dd:[2],d:[1,2],hh:[2],h:[1,2],mm:[2],m:[1,2],ss:[2],s:[1,2]," ":0,"-":0,"/":0,":":0},"undefined"!=typeof module&&(module.exports=DateVal),"undefined"!=typeof module&&(module.exports=extend),FVRuleField.types={},FVRuleField.add_field_type=function(e){FVRuleField.types[e.name]={display_name:e.display_name,"class":e["class"]}},FVRuleField.create_field=function(e,t){var r=null,i=BasicVal.object(!0).check(e);if(i)return[i,null];var n=new FieldVal(e),l=[BasicVal.string(!1)];t&&(void 0!==t.need_name&&t.need_name===!0&&l.push(BasicVal.string(!0)),void 0!==t.allow_dots&&t.allow_dots===!1&&l.push(BasicVal.does_not_contain(["."])),t.existing_names&&l.push(BasicVal.not_one_of(t.existing_names,{error:{error:1e3,error_message:"Name already used"}}))),n.get("name",l);var a=n.get("type",BasicVal.string(!0),BasicVal.one_of(FVRuleField.types));if(!a)return[n.end(),null];var o=FVRuleField.types[a],s=o["class"];r=new s(e,n);var d=r.init();return null!=d?[d,null]:[null,r]},FVRuleField.prototype.validate_as_field=function(e,t){var r=this;t.get_async(e,r.checks)},FVRuleField.prototype.validate=function(e,t){var r=this;if(!t)throw new Error("No callback specified");return FieldVal.use_checks(e,r.checks,{},function(e){t(e)})},FVRuleField.prototype.make_nested=function(){},FVRuleField.prototype.init=function(){},FVRuleField.prototype.remove=function(){},FVRuleField.prototype.view_mode=function(){},FVRuleField.prototype.edit_mode=function(){},FVRuleField.prototype.change_name=function(){},FVRuleField.prototype.disable=function(){},FVRuleField.prototype.enable=function(){},FVRuleField.prototype.focus=function(){},FVRuleField.prototype.blur=function(){},FVRuleField.prototype.val=function(){},"undefined"!=typeof module&&(module.exports=FVRuleField),"function"==typeof require&&(extend=require("extend")),extend(FVBasicRuleField,FVRuleField),FVBasicRuleField.prototype.init=function(){var e=this;return e.ui_field.init.apply(e.ui_field,arguments)},FVBasicRuleField.prototype.remove=function(){var e=this;return e.ui_field.remove.apply(e.ui_field,arguments)},FVBasicRuleField.prototype.in_array=function(){var e=this;return e.ui_field.in_array.apply(e.ui_field,arguments)},FVBasicRuleField.prototype.in_key_value=function(){var e=this;return e.ui_field.in_key_value.apply(e.ui_field,arguments)},FVBasicRuleField.prototype.change_name=function(){var e=this;return e.ui_field.change_name.apply(e.ui_field,arguments)},FVBasicRuleField.prototype.disable=function(){var e=this;return e.ui_field.disable.apply(e.ui_field,arguments)},FVBasicRuleField.prototype.enable=function(){var e=this;return e.ui_field.enable.apply(e.ui_field,arguments)},FVBasicRuleField.prototype.name_val=function(){var e=this;return e.ui_field.name_val.apply(e.ui_field,arguments)},FVBasicRuleField.prototype.val=function(){var e=this;return e.ui_field.val.apply(e.ui_field,arguments)},FVBasicRuleField.prototype.error=function(){var e=this;return e.ui_field.error.apply(e.ui_field,arguments)},FVBasicRuleField.prototype.blur=function(){var e=this;return e.ui_field.blur.apply(e.ui_field,arguments)},FVBasicRuleField.prototype.focus=function(){var e=this;return e.ui_field.blur.apply(e.ui_field,arguments)},"undefined"!=typeof module&&(module.exports=FVBasicRuleField),"function"==typeof require&&(extend=require("extend"),FVBasicRuleField=require("./FVBasicRuleField")),extend(FVTextRuleField,FVBasicRuleField),FVTextRuleField.prototype.create_ui=function(e){var t=this,r=t.json.type;return t.json.textarea===!0&&(r="textarea"),t.ui_field=new FVTextField(t.display_name||t.name,{name:t.json.name,display_name:t.json.display_name,type:r}),t.element=t.ui_field.element,e.add_field(t.name,t),t.ui_field},FVTextRuleField.prototype.init=function(){var e=this;return e.checks.push(BasicVal.string(e.required)),e.min_length=e.validator.get("min_length",BasicVal.integer(!1)),void 0!==e.min_length&&e.checks.push(BasicVal.min_length(e.min_length,{stop_on_error:!1})),e.max_length=e.validator.get("max_length",BasicVal.integer(!1)),void 0!==e.max_length&&e.checks.push(BasicVal.max_length(e.max_length,{stop_on_error:!1})),e.textarea=e.validator.get("textarea",BasicVal["boolean"](!1)),e.phrase=e.validator.get("phrase",BasicVal.string(!1)),e.equal_to=e.validator.get("equal_to",BasicVal.string(!1)),e.ci_equal_to=e.validator.get("ci_equal_to",BasicVal.string(!1)),e.prefix=e.validator.get("prefix",BasicVal.string(!1)),e.ci_prefix=e.validator.get("ci_prefix",BasicVal.string(!1)),e.query=e.validator.get("query",BasicVal.string(!1)),e.validator.end()},"undefined"!=typeof module&&(module.exports=FVTextRuleField),"function"==typeof require&&(extend=require("extend"),FVBasicRuleField=require("./FVBasicRuleField")),extend(FVNumberRuleField,FVBasicRuleField),FVNumberRuleField.prototype.create_ui=function(e){var t=this;
return t.ui_field=new FVTextField(t.display_name||t.name,t.json),t.element=t.ui_field.element,e.add_field(t.name,t),t.ui_field},FVNumberRuleField.prototype.init=function(){var e=this;return e.checks.push(BasicVal.number(e.required)),e.minimum=e.validator.get("minimum",BasicVal.number(!1)),null!=e.minimum&&e.checks.push(BasicVal.minimum(e.minimum,{stop_on_error:!1})),e.maximum=e.validator.get("maximum",BasicVal.number(!1)),null!=e.maximum&&e.checks.push(BasicVal.maximum(e.maximum,{stop_on_error:!1})),e.integer=e.validator.get("integer",BasicVal["boolean"](!1)),e.integer&&e.checks.push(BasicVal.integer(!1,{stop_on_error:!1})),e.validator.end()},"undefined"!=typeof module&&(module.exports=FVNumberRuleField),"function"==typeof require&&(extend=require("extend"),FVBasicRuleField=require("./FVBasicRuleField"),FVRule=require("../FVRule")),extend(FVObjectRuleField,FVBasicRuleField),FVObjectRuleField.prototype.create_ui=function(e,t){var r=this;if(r.any)if(r.field_type){r.ui_field=new FVKeyValueField(r.display_name||r.name,r.json),r.element=r.ui_field.element,r.ui_field.new_field=function(e){return r.new_field(e)};var i=r.ui_field.remove_field;r.ui_field.remove_field=function(e){for(var t=0;t<r.fields.length;t++)r.fields[t]===e&&r.fields.splice(t,1);return i.call(r.ui_field,e)}}else r.ui_field=new FVTextField(r.display_name||r.name,{type:"textarea"}),r.ui_field.val=function(e){var t=this;if(0===arguments.length){var r=t.input.val();if(0===r.length)return null;try{return JSON.parse(r)}catch(i){console.error("FAILED TO PARSE: ",r)}return r}return t.input.val(JSON.stringify(e,null,4)),t},r.element=r.ui_field.element;else{r.ui_field=t?t:new FVObjectField(r.display_name||r.name,r.json);for(var n in r.fields){var l=r.fields[n];l.create_ui(r.ui_field)}r.element=r.ui_field.element}return t||e.add_field(r.name,r.ui_field),r.ui_field},FVObjectRuleField.prototype.new_field=function(){var e=this,t=FVRuleField.create_field(e.field_type.json),r=(t[0],t[1]);return r.create_ui(e.ui_field)},FVObjectRuleField.prototype.init=function(){var e=this;e.checks.push(BasicVal.object(e.required)),e.fields={};var t=e.validator.get("fields",BasicVal.array(!1));if(null!=t){for(var r=new FieldVal(null),i=0;i<t.length;i++){var n=t[i],l=FVRuleField.create_field(n,{need_name:!0,existing_names:e.fields}),a=l[0],o=l[1];null==a?e.fields[o.name]=o:r.invalid(i,a)}var s=r.end();null!=s&&e.validator.invalid("fields",s)}return e.any=e.validator.get("any",BasicVal["boolean"](!1)),e.any||e.checks.push(function(t,r,i){var n=new FieldVal(t);for(var l in e.fields){var a=e.fields[l];a.validate_as_field(l,n)}return n.end(function(e){i(e)})}),e.validator.get("field_type",BasicVal.object(!1),{check:function(){return e.any?void 0:FVRule.errors.field_type_without_any()},stop_on_error:!0},function(t){var r=FVRuleField.create_field(t),i=r[0];return e.field_type=r[1],i?i:void e.checks.push(function(t){var r=new FieldVal(t);for(var i in t)t.hasOwnProperty(i)&&e.field_type.validate_as_field(i,r);return r.end()})}),e.validator.end()},"undefined"!=typeof module&&(module.exports=FVObjectRuleField),"function"==typeof require&&(extend=require("extend"),FVBasicRuleField=require("./FVBasicRuleField"),FVRule=require("../FVRule")),extend(FVArrayRuleField,FVBasicRuleField),FVArrayRuleField.prototype.create_ui=function(e){var t=this;t.ui_field=new FVArrayField(t.display_name||t.name,t.json),t.ui_field.new_field=function(e){return t.new_field(e)};var r=t.ui_field.remove_field;return t.ui_field.remove_field=function(e){for(var i=0;i<t.fields.length;i++)t.fields[i]===e&&t.fields.splice(i,1);return r.call(t.ui_field,e)},t.element=t.ui_field.element,e.add_field(t.name,t),t.ui_field},FVArrayRuleField.prototype.new_field=function(e){var t=this,r=t.rule_for_index(e);return r.create_ui(t.ui_field)},FVArrayRuleField.prototype.rule_for_index=function(e){var t=this,r=t.rules[e];if(!r){{var i=t.rule_json_for_index(e),n=FVRuleField.create_field(i);n[0]}r=n[1],t.rules[e]=r}return r},FVArrayRuleField.prototype.rule_json_for_index=function(e){var t=this,r=t.indices[e];if(!r&&t.interval){var i=e%t.interval;r=t.interval_offsets[i]}return r||(r=t.indices["*"]),r},FVArrayRuleField.integer_regex=/^(\d+)$/,FVArrayRuleField.interval_regex=/^(\d+)n(\+(\d+))?$/,FVArrayRuleField.prototype.init=function(){var e=this;e.checks.push(BasicVal.array(e.required)),e.indices={};var t=e.validator.get("indices",BasicVal.object(!1));if(null!=t){var r=new FieldVal(null);for(var i in t){var n=t[i],l=FVRuleField.create_field(n),a=l[0];if(null==a){var o=i.match(FVArrayRuleField.interval_regex);if(o){var s=o[1],d=o[3]||0;if(e.interval&&s!==e.interval){r.invalid(i,FieldVal.create_error(FVRule.errors.interval_conflict,{},s,e.interval));continue}e.interval=s,e.interval_offsets[d]=n}else{var u=i.match(FVArrayRuleField.integer_regex);if(u){var c=u[1];e.indices[c]=n}else"*"===i?e.indices["*"]=n:r.invalid(i,FieldVal.create_error(FVRule.errors.invalid_indices_format,{}))}}else r.invalid(i,a)}var f=r.end();f&&e.validator.invalid("indices",f)}return e.checks.push(function(t){for(var r=new FieldVal(t),i=0;i<t.length;i++){var n=e.rule_for_index(i);n.validate_as_field(i,r)}var l=r.end();return l}),e.validator.end()},"undefined"!=typeof module&&(module.exports=FVArrayRuleField),"function"==typeof require&&(extend=require("extend"),FVBasicRuleField=require("./FVBasicRuleField")),extend(FVChoiceRuleField,FVBasicRuleField),FVChoiceRuleField.prototype.create_ui=function(e){var t=this;return t.json.choices=t.choices,t.ui_field=new FVChoiceField(t.display_name||t.name,t.json),t.element=t.ui_field.element,e.add_field(t.name,t),t.ui_field},FVChoiceRuleField.prototype.init=function(){var e=this;return e.allow_empty=e.validator.get("allow_empty",BasicVal["boolean"](!1)),e.empty_message=e.validator.get("empty_message",BasicVal.string(!1)),e.choices=e.validator.get("choices",BasicVal.array(!0)),void 0!==e.choices&&e.checks.push(BasicVal.one_of(e.choices,{stop_on_error:!1})),e.validator.end()},"undefined"!=typeof module&&(module.exports=FVChoiceRuleField),"function"==typeof require&&(extend=require("extend"),FVBasicRuleField=require("./FVBasicRuleField")),extend(FVBooleanRuleField,FVBasicRuleField),FVBooleanRuleField.prototype.create_ui=function(e){var t=this;return t.ui_field=new FVBooleanField(t.display_name||t.name,t.json),t.element=t.ui_field.element,e.add_field(t.name,t),t.ui_field},FVBooleanRuleField.prototype.init=function(){var e=this;return e.checks.push(BasicVal["boolean"](e.required)),e.equal_to=e.validator.get("equal_to",BasicVal["boolean"](!1)),void 0!==e.equal_to&&e.checks.push(BasicVal.equal_to(e.equal_to)),e.validator.end()},"undefined"!=typeof module&&(module.exports=FVBooleanRuleField),"function"==typeof require&&(extend=require("extend"),FVBasicRuleField=require("./FVBasicRuleField")),extend(FVEmailRuleField,FVBasicRuleField),FVEmailRuleField.prototype.create_ui=function(e){var t=this;return t.ui_field=new FVTextField(t.display_name||t.name,t.json),t.element=t.ui_field.element,e.add_field(t.name,t),t.ui_field},FVEmailRuleField.prototype.init=function(){var e=this;return e.checks.push(BasicVal.string(e.required),BasicVal.email()),e.validator.end()},"undefined"!=typeof module&&(module.exports=FVEmailRuleField),"function"==typeof require&&(FieldVal=require("fieldval"),BasicVal=require("fieldval-basicval"),FVRuleField=require("./fields/FVRuleField")),FVRule.errors={interval_conflict:function(e,t){return{error:501,error_message:"Only one interval can be used.",interval:e,existing:t}},invalid_indices_format:function(){return{error:502,error_message:"Invalid format for an indices rule."}},field_type_without_any:function(){return{error:503,error_message:"field_type can't be used with setting any to true."}}},FVRule.FVRuleField=FVRuleField,FVRule.prototype.init=function(e,t){var r=this,i=FVRuleField.create_field(e,t);return i[0]?i[0]:(r.field=i[1],null)},FVRule.prototype.create_form=function(){var e=this;if(FVForm){var t=new FVForm;return e.field.create_ui(t,t),t}},FVRule.prototype.validate=function(){var e=this;return e.field.validate.apply(e.field,arguments)},"undefined"!=typeof module&&(module.exports=FVRule),FVRuleField.add_field_type({name:"text",display_name:"Text","class":"undefined"!=typeof FVTextRuleField?FVTextRuleField:require("./fields/FVTextRuleField")}),FVRuleField.add_field_type({name:"string",display_name:"String","class":"undefined"!=typeof FVTextRuleField?FVTextRuleField:require("./fields/FVTextRuleField")}),FVRuleField.add_field_type({name:"boolean",display_name:"Boolean","class":"undefined"!=typeof FVBooleanRuleField?FVBooleanRuleField:require("./fields/FVBooleanRuleField")}),FVRuleField.add_field_type({name:"number",display_name:"Number","class":"undefined"!=typeof FVNumberRuleField?FVNumberRuleField:require("./fields/FVNumberRuleField")}),FVRuleField.add_field_type({name:"object",display_name:"Object","class":"undefined"!=typeof FVObjectRuleField?FVObjectRuleField:require("./fields/FVObjectRuleField")}),FVRuleField.add_field_type({name:"array",display_name:"Array","class":"undefined"!=typeof FVArrayRuleField?FVArrayRuleField:require("./fields/FVArrayRuleField")}),FVRuleField.add_field_type({name:"choice",display_name:"Choice","class":"undefined"!=typeof FVChoiceRuleField?FVChoiceRuleField:require("./fields/FVChoiceRuleField")}),FVRuleField.add_field_type({name:"email",display_name:"Email","class":"undefined"!=typeof FVEmailRuleField?FVEmailRuleField:require("./fields/FVEmailRuleField")}),FVField.prototype.in_array=function(e){var t=this;t.is_in_array=!0,t.element.addClass("fv_in_array").append(t.move_handle=$("<div />").addClass("fv_field_move_handle"),t.remove_button=$("<button />").addClass("fv_field_remove_button").html("&#10006;").on(FVForm.button_event,function(r){r.preventDefault(),e(),t.remove()}))},FVField.prototype.in_key_value=function(e,t){var r=this;r.key_value_parent=e,r.is_in_key_value=!0,r.name_input=new FVTextField("Key").on_change(function(e){r.key_name=r.key_value_parent.change_key_name(r.key_name,e,r)}),r.name_input.element.addClass("fv_key_value_name_input"),r.title.replaceWith(r.name_input.element),r.element.addClass("fv_in_key_value").append(r.remove_button=$("<button />").addClass("fv_field_remove_button").html("&#10006;").on(FVForm.button_event,function(e){e.preventDefault(),t(),r.remove()}))},FVField.prototype.init=function(){},FVField.prototype.remove=function(e){var t=this;t.element.remove(),t.parent&&!e&&(t.parent.remove_field(t),t.parent=null)},FVField.prototype.change_name=function(e){var t=this;return t.name=e,t},FVField.prototype.layout=function(){var e=this;e.element.append(e.title,e.description_label,e.input_holder,e.error_message)},FVField.prototype.on_change=function(e){var t=this;return t.on_change_callbacks.push(e),t},FVField.prototype.output=function(e){var t=this;return t.output_flag=e,t},FVField.prototype.did_change=function(){for(var e=this,t=e.val(),r=0;r<e.on_change_callbacks.length;r++){var i=e.on_change_callbacks[r];i(t)}return e},FVField.prototype.icon=function(){},FVField.prototype.val=function(){console.error("Did not override FVField.val()")},FVField.prototype.disable=function(){var e=this;return e.is_disabled=!0,e.element.addClass("fv_disabled"),e.is_in_array&&(e.move_handle.hide(),e.remove_button.hide()),e},FVField.prototype.enable=function(){var e=this;return e.is_disabled=!1,e.element.removeClass("fv_disabled"),e.is_in_array&&(e.move_handle.show(),e.remove_button.show()),e},FVField.prototype.blur=function(){},FVField.prototype.focus=function(){},FVField.prototype.show_error=function(){var e=this;e.error_message.show()},FVField.prototype.hide_error=function(){var e=this;e.error_message.hide()},FVField.prototype.name_val=function(){var e=this,t=e.name_input.val.apply(e.name_input,arguments);return e.key_name=e.key_value_parent.change_key_name(e.key_name,e.name_input.val(),e),t},FVField.prototype.error=function(e){var t=this;if(e){if(t.error_message.empty(),4===e.error){for(var r=$("<ul />"),i=0;i<e.errors.length;i++){var n=e.errors[i];r.append($("<li />").text(n.error_message))}t.error_message.append(r)}else t.error_message.append($("<span />").text(e.error_message));t.element&&t.element.addClass("fv_field_error"),t.show_error()}else t.hide_error(),t.element&&t.element.removeClass("fv_field_error")},fieldval_ui_extend(FVTextField,FVField),FVTextField.prototype.check_changed=function(){var e=this,t=e.val();t!==e.previous_value&&(e.previous_value=t,e.did_change())},FVTextField.prototype.on_enter=function(e){var t=this;return t.enter_callbacks.push(e),t},FVTextField.prototype.icon=function(e){var t=this,r={"background-image":"url("+e.background+")","background-position":e.position,"background-repeat":"no-repeat","padding-left":e.width+"px"};return t.input.css(r),t},FVTextField.prototype.change_name=function(e){var t=this;return FVTextField.superClass.change_name.call(this,e),t.input.attr("placeholder",e),t},FVTextField.prototype.disable=function(){var e=this;return e.input.attr("disabled","disabled"),FVField.prototype.disable.call(this)},FVTextField.prototype.enable=function(){var e=this;return e.input.attr("disabled",null),FVField.prototype.enable.call(this)},FVTextField.prototype.focus=function(){var e=this;return e.input.focus(),e},FVTextField.prototype.blur=function(){var e=this;return e.input.blur(),e},FVTextField.numeric_regex=/^\d+(\.\d+)?$/,FVTextField.prototype.val=function(e){var t=this;if(0===arguments.length){var r=t.input.val();return"number"===t.input_type&&FVTextField.numeric_regex.test(r)?parseFloat(r):0===r.length?null:r}return t.input.val(e),t},fieldval_ui_extend(FVPasswordField,FVTextField),fieldval_ui_extend(FVDisplayField,FVField),FVDisplayField.prototype.icon=function(e){var t=this,r={"background-image":"url("+e.background+")","background-position":e.position,"background-repeat":"no-repeat","padding-left":e.width+"px"};return t.input.css(r),t},FVDisplayField.replace_line_breaks=function(e){if("string"!=typeof e)return e;for(var t=[],r=e.split(/\n/),i=jQuery(document.createElement("div")),n=0;n<r.length;n++)t.push(i.text(r[n]).html());return t.join("<br>")},FVDisplayField.prototype.val=function(e){var t=this;return 0===arguments.length?t.input.text():(t.input.html(FVDisplayField.replace_line_breaks(e)),t)},fieldval_ui_extend(FVChoiceField,FVField),FVChoiceField.prototype.filter_enter_up=function(){var e=this;console.log("clicked enter first"),e.select_highlighted()},FVChoiceField.prototype.filter_esc_up=function(){var e=this;e.hide_list()},FVChoiceField.prototype.filter_key_up=function(e){var t=this;return 40===e.keyCode?(t.move_down(),void e.preventDefault()):38===e.keyCode?(t.move_up(),void e.preventDefault()):13===e.keyCode?(t.filter_enter_up(),void e.preventDefault()):(27===e.keyCode&&(t.filter_esc_up(),e.preventDefault()),void t.filter(t.filter_input.val()))},FVChoiceField.prototype.filter_key_down=function(e){(38===e.keyCode||40===e.keyCode||13===e.keyCode)&&e.preventDefault()},FVChoiceField.prototype.show_list=function(){var e=this;e.is_disabled||(e.input_holder.css("min-height",e.current_display.outerHeight()+"px"),e.filter_input.show(),e.current_display.hide(),FVForm.is_mobile||e.filter_input.focus(),e.choice_list.show(),e.current_highlight=null,e.filter(e.filter_input.val(),!0))},FVChoiceField.prototype.hide_list=function(){var e=this;e.input_holder.css("min-height",""),e.filter_input.hide(),e.current_display.show(),e.choice_list.hide()},FVChoiceField.prototype.filter=function(e,t){var r=this,i=e.toLowerCase();r.choice_list.empty();for(var n=0;n<r.choice_values.length;n++){var l=r.choice_values[n],a=r.choice_texts[n];(""===a&&""===i||0==a.toLowerCase().indexOf(i))&&r.add_option(l,a,t)}t&&r.current_highlight||(r.current_highlight=$(r.choice_list.children()[0])),r.current_highlight&&r.current_highlight.addClass("highlighted")},FVChoiceField.prototype.value_to_text=function(e){for(var t=this,r=0;r<t.choice_values.length;r++){var i=t.choice_values[r];if(i===e)return t.choice_texts[r]}return null},FVChoiceField.prototype.select_option=function(e,t){var r=this;r.selected_value=e;var i=r.value_to_text(e);null===e&&null===i?r.current_display.addClass("fv_choice_placeholder").text(r.name):r.current_display.removeClass("fv_choice_placeholder").text(i),r.hide_list(),r.filter_input.blur().hide().val(""),t||r.did_change()},FVChoiceField.prototype.move_up=function(){var e=this;if(e.current_highlight){e.current_highlight.removeClass("highlighted");var t=e.current_highlight.prev();t[0]?(e.current_highlight=t,e.current_highlight.addClass("highlighted"),e.move_into_view()):e.current_highlight=null}},FVChoiceField.prototype.move_down=function(){var e=this;if(e.current_highlight){var t=e.current_highlight.next();t[0]&&(e.current_highlight.removeClass("highlighted"),e.current_highlight=t,e.current_highlight.addClass("highlighted"),e.move_into_view())}else e.current_highlight=$(e.choice_list.children()[0]),e.current_highlight&&e.current_highlight.addClass("highlighted")},FVChoiceField.prototype.move_into_view=function(e){var t=this;void 0===e&&(e=t.current_highlight),setTimeout(function(){var r=e.offset().top;t.choice_list.scrollTop(t.choice_list.scrollTop()-t.choice_list.offset().top+r-50)},1)},FVChoiceField.prototype.add_option=function(e,t,r){var i=this,n=$("<div />").addClass("fv_choice_option").data("value",e).text(t).on(FVForm.button_event,function(t){i.default_click(t,e)});i.finalize_option(n,e,r)},FVChoiceField.prototype.default_click=function(e,t){var r=this;e.preventDefault(),e.stopPropagation(),e.originalEvent&&(e.originalEvent.preventDefault(),e.originalEvent.stopPropagation()),r.select_option(t)},FVChoiceField.prototype.finalize_option=function(e,t,r){var i=this;i.selected_value===t&&(e.addClass("selected"),i.move_into_view(e),r&&(i.current_highlight=e)),e.appendTo(i.choice_list)},FVChoiceField.prototype.select_highlighted=function(){var e=this;e.current_highlight&&e.current_highlight[0]&&e.select_option(e.current_highlight.data("value"))},FVChoiceField.prototype.focus=function(){var e=this;return e.filter_input.val(""),setTimeout(function(){e.show_list()},1),e},FVChoiceField.prototype.blur=function(){var e=this;return e.hide_list(),e},FVChoiceField.prototype.val=function(e){var t=this;return 0===arguments.length?t.selected_value:(void 0!==e&&t.select_option(e,!0),t)},fieldval_ui_extend(FVDateField,FVField),FVDateField.prototype.add_element_from_component=function(e,t){var r=this;if(0===t){var i=e;r.inputs.push(null),r.input_holder.append($("<div />").addClass("fv_date_separator").text(i))}else{var n=t[t.length-1],l=$("<input />").attr({placeholder:e,size:n,maxlength:n}).addClass("fv_date_input").on("keyup",function(){r.did_change()});l.blur(function(){var e=l.val(),r=DateVal.pad_to_valid(e,t);l.val(r)}),r.inputs.push(l),r.input_holder.append(l)}},FVDateField.prototype.icon=function(){var e=this;return e},FVDateField.prototype.change_name=function(e){var t=this;return FVDateField.superClass.change_name.call(this,e),t.input.attr("placeholder",e),t},FVDateField.prototype.disable=function(){for(var e=this,t=0;t<e.inputs.length;t++){var r=e.inputs[t];r&&r.attr("disabled","disabled")}return FVField.prototype.disable.call(this)},FVDateField.prototype.enable=function(){for(var e=this,t=0;t<e.inputs.length;t++){var r=e.inputs[t];r&&r.attr("disabled",null)}return FVField.prototype.enable.call(this)},FVDateField.prototype.focus=function(){var e=this,t=e.inputs[0];return t&&t.blur(),e},FVDateField.prototype.blur=function(){for(var e=this,t=0;t<e.inputs.length;t++){var r=e.inputs[t];r&&r.blur()}return e},FVDateField.prototype.val=function(e){var t=this;if(0===arguments.length){for(var r="",i=0;i<t.format_array.length;i++){var n=t.format_array[i],l=DateVal.date_components[n];if(0===l)r+=n;else{var a=t.inputs[i],o=a.val().toString();r+=DateVal.pad_to_valid(o,l)}}return r}if(null!=e){"number"==typeof e?e=DateVal.date_with_format_array(new Date(e),t.format_array):e instanceof Date&&(e=DateVal.date_with_format_array(e,t.format_array));var s=DateVal.date(t.format_string,{emit:DateVal.EMIT_COMPONENT_ARRAY}).check(e,function(e){as_components=e});if(s)return void console.error("Invalid format passed to .val of FVDateField");for(var i=0;i<t.format_array.length;i++){var n=t.format_array[i],l=DateVal.date_components[n];if(0===l)r+=n;else{var a=t.inputs[i];a.val(as_components[i])}}}return t},fieldval_ui_extend(FVBooleanField,FVField),FVBooleanField.prototype.disable=function(){var e=this;return e.input.attr("disabled","disabled"),FVField.prototype.disable.call(this)},FVBooleanField.prototype.enable=function(){var e=this;return e.input.attr("disabled",null),FVField.prototype.enable.call(this)},FVBooleanField.prototype.focus=function(){var e=this;return e.input.focus(),e},FVBooleanField.prototype.blur=function(){var e=this;return e.input.blur(),e},FVBooleanField.prototype.val=function(e){var t=this;return 0===arguments.length?t.input.is(":checked"):("true"===e?e=!0:"false"===e&&(e=!1),t.input.prop("checked",e),t)},fieldval_ui_extend(FVObjectField,FVField),FVObjectField.prototype.init=function(){var e=this;for(var t in e.fields){var r=e.fields[t];r.init()}},FVObjectField.prototype.remove=function(){var e=this;for(var t in e.fields){var r=e.fields[t];r.remove()}FVField.prototype.remove.call(this)},FVObjectField.prototype.add_field=function(e,t){var r=this;return t.element.appendTo(r.fields_element),r.fields[e]=t,t.parent=r,r},FVObjectField.prototype.remove_field=function(e){var t,r,i=this;if("string"==typeof e)t=i.fields[e],r=e;else{if(!(e instanceof FVField))throw new Error("FVObjectField.remove_field only accepts strings or FVField instances");for(var n in i.fields)i.fields.hasOwnProperty(n)&&i.fields[n]===e&&(t=i.fields[n],r=n)}t&&(t.remove(!0),delete i.fields[r])},FVObjectField.prototype.change_name=function(e){var t=this;return FVObjectField.superClass.change_name.call(this,e),t},FVObjectField.prototype.disable=function(){var e=this;for(var t in e.fields){var r=e.fields[t];r.disable()}return FVField.prototype.disable.call(this)},FVObjectField.prototype.enable=function(){var e=this;for(var t in e.fields){var r=e.fields[t];r.enable()}return FVField.prototype.enable.call(this)},FVObjectField.prototype.focus=function(){var e=this;return e},FVObjectField.prototype.blur=function(){var e=this;for(var t in e.fields){var r=e.fields[t];r.blur()}return e},FVObjectField.prototype.error=function(e){var t=this;if(FVObjectField.superClass.error.call(this,e),t.error_message.empty(),e){if(void 0===e.error)return void console.error("No error provided");if(0===e.error)t.fields_error(e),t.hide_error();else{if(4===e.error){for(var r=$("<ul />"),i=0;i<e.errors.length;i++){var n=e.errors[i];0===n.error?t.fields_error(n):r.append($("<li />").text(n.error_message))}t.error_message.append(r)}else t.error_message.append($("<span />").text(e.error_message));t.show_error()}}else t.fields_error(null),t.hide_error()},FVObjectField.prototype.fields_error=function(e){var t=this;if(e){var r=e.invalid||{},i=e.missing||{},n=e.unrecognized||{};for(var l in t.fields){var a=t.fields[l],o=r[l]||i[l]||n[l]||null;a.error(o)}}else for(var l in t.fields){var a=t.fields[l];a.error(null)}},FVObjectField.prototype.clear_errors=function(){var e=this;e.error(null)},FVObjectField.prototype.val=function(e){var t=this;if(0===arguments.length){var r={};for(var i in t.fields){var n=t.fields[i];if(n.output_flag!==!1){var l=n.val();null!=l&&(r[i]=l)}}return r}for(var i in e){var n=t.fields[i];n&&n.val(e[i])}return t},function(e,t,r,i){function n(t,i){this.w=e(r),this.el=e(t),this.options=e.extend({},o,i),this.init()}var l="ontouchstart"in r,a=function(){var e=r.createElement("div"),i=r.documentElement;if(!("pointerEvents"in e.style))return!1;e.style.pointerEvents="auto",e.style.pointerEvents="x",i.appendChild(e);var n=t.getComputedStyle&&"auto"===t.getComputedStyle(e,"").pointerEvents;return i.removeChild(e),!!n}(),o={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",placeClass:"dd-placeholder",group:0,threshold:20};n.prototype={init:function(){var r=this;r.reset(),r.el.data("nestable-group",this.options.group),r.placeEl=e('<div class="'+r.options.placeClass+'"/>'),e.each(this.el.find(r.options.itemNodeName),function(t,i){r.setParent(e(i))});var i=function(t){var i=e(t.target);if(!i.hasClass(r.options.handleClass)){if(i.closest("."+r.options.noDragClass).length)return;i=i.closest("."+r.options.handleClass)}i.length&&!r.dragEl&&(r.isTouch=/^touch/.test(t.type),r.isTouch&&1!==t.touches.length||(t.preventDefault(),r.dragStart(t.touches?t.touches[0]:t)))},n=function(e){r.dragEl&&(e.preventDefault(),r.dragMove(e.touches?e.touches[0]:e))},a=function(e){r.dragEl&&(e.preventDefault(),r.dragStop(e.touches?e.touches[0]:e))};l&&(r.el[0].addEventListener("touchstart",i,!1),t.addEventListener("touchmove",n,!1),t.addEventListener("touchend",a,!1),t.addEventListener("touchcancel",a,!1)),r.el.on("mousedown",i),r.w.on("mousemove",n),r.w.on("mouseup",a)},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.hasNewRoot=!1,this.pointEl=null},setParent:function(e){e.children('[data-action="expand"]').hide()},unsetParent:function(e){e.children("[data-action]").remove(),e.children(this.options.listNodeName).remove()},dragStart:function(t){var n=this.mouse,l=e(t.target),a=l.closest(this.options.itemNodeName);this.placeEl.css("height",a.height()),this.placeEl.css("width",a.width()),this.placeEl.css("display",a.css("display")),n.offsetX=t.offsetX!==i?t.offsetX:t.pageX-l.offset().left,n.offsetY=t.offsetY!==i?t.offsetY:t.pageY-l.offset().top,n.startX=n.lastX=t.pageX,n.startY=n.lastY=t.pageY,this.dragRootEl=this.el,this.el_offset=this.el.offset(),this.dragEl=e(r.createElement(this.options.listNodeName)).addClass(this.options.dragClass),this.dragEl.css("width",a.width()),a.after(this.placeEl),a[0].parentNode.removeChild(a[0]),a.appendTo(this.dragEl),e(this.el).append(this.dragEl),this.dragEl.css({left:t.pageX-n.offsetX-this.el_offset.left,top:t.pageY-n.offsetY-this.el_offset.top})},dragStop:function(){var e=this.dragEl.children(this.options.itemNodeName).first();e[0].parentNode.removeChild(e[0]),this.placeEl.replaceWith(e),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(i){var n=this.options,l=this.mouse;this.dragEl.css({left:i.pageX-l.offsetX-this.el_offset.left,top:i.pageY-l.offsetY-this.el_offset.top}),l.lastX=l.nowX,l.lastY=l.nowY,l.nowX=i.pageX,l.nowY=i.pageY,l.distX=l.nowX-l.lastX,l.distY=l.nowY-l.lastY,l.lastDirX=l.dirX,l.lastDirY=l.dirY,l.dirX=0===l.distX?0:l.distX>0?1:-1,l.dirY=0===l.distY?0:l.distY>0?1:-1;var o=Math.abs(l.distX)>Math.abs(l.distY)?1:0;if(!l.moving)return l.dirAx=o,void(l.moving=!0);l.dirAx!==o?(l.distAxX=0,l.distAxY=0):(l.distAxX+=Math.abs(l.distX),0!==l.dirX&&l.dirX!==l.lastDirX&&(l.distAxX=0),l.distAxY+=Math.abs(l.distY),0!==l.dirY&&l.dirY!==l.lastDirY&&(l.distAxY=0)),l.dirAx=o;if(a||(this.dragEl[0].style.visibility="hidden"),this.pointEl=e(r.elementFromPoint(i.pageX-r.body.scrollLeft,i.pageY-(t.pageYOffset||r.documentElement.scrollTop))),this.pointEl.hasClass(n.itemClass)||(this.pointEl=this.pointEl.closest("."+n.itemClass)),a||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(n.handleClass))this.pointEl=this.pointEl.closest("."+n.itemClass);else if(!this.pointEl.length||!this.pointEl.hasClass(n.itemClass))return;var s=this.pointEl.closest("."+n.rootClass);if(n.group===s.data("nestable-group")){var d=(i.pageY-this.pointEl.offset().top,i.pageY-this.pointEl.offset().top,i.pageX<this.pointEl.offset().left+this.pointEl.width()/2),u=i.pageY<this.pointEl.offset().top+this.pointEl.height()/2;"block"===this.pointEl.css("display")?u?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl):u&&d?this.pointEl.before(this.placeEl):u||d||this.pointEl.after(this.placeEl)}}},e.fn.nestable=function(t){var r=this,i=this;return r.each(function(){var r=e(this).data("nestable");r?"string"==typeof t&&"function"==typeof r[t]&&(i=r[t]()):(e(this).data("nestable",new n(this,t)),e(this).data("nestable-id",(new Date).getTime()))}),i||r}}(window.jQuery||window.Zepto,window,document),fieldval_ui_extend(FVArrayField,FVField),FVArrayField.prototype.reorder=function(){var e=this;e.fields=[];for(var t=e.fields_element.children(),r=0;r<t.length;r++){var i=$(t[r]),n=i.data("field");e.fields.push(n)}},FVArrayField.prototype.create_add_field_button=function(){var e=this,t=$("<button />").addClass("fv_add_field_button").text(e.add_button_text).on(FVForm.button_event,function(t){t.preventDefault(),e.new_field(e.fields.length)});return e.add_field_buttons.push(t),t},FVArrayField.prototype.new_field=function(){throw new Error("FVArrayField.new_field must be overriden to create fields")},FVArrayField.prototype.add_field=function(e,t){var r=this;t.in_array(function(){r.remove_field(t)}),t.element.appendTo(r.fields_element),r.fields.push(t),t.parent=r,r.input_holder.nestable("init"),r.is_disabled&&t.disable()},FVArrayField.prototype.remove_field=function(e){var t,r,i=this;if("number"==typeof e&&e%1===0&&e>=0)r=e,t=i.fields[e];else{if(!(e instanceof FVField))throw new Error("FVArrayField.remove_field only accepts non-negative integers or FVField instances");for(var n in i.fields)if(i.fields.hasOwnProperty(n)&&i.fields[n]===e){r=n,t=i.fields[n];break}}t&&(t.remove(!0),i.fields.splice(r,1))},FVArrayField.prototype.error=function(e){FVArrayField.superClass.error.call(this,e)},FVArrayField.prototype.fields_error=function(e){var t=this;if(e)for(var r=e.invalid||{},i=e.missing||{},n=e.unrecognized||{},l=0;l<t.fields.length;l++){var a=t.fields[l],o=r[l]||i[l]||n[l]||null;a.error(o)}else for(var l in t.fields){var a=t.fields[l];a.error(null)}},FVArrayField.prototype.clear_errors=function(){for(var e=this,t=0;t<e.fields.length;t++){var r=e.fields[t];r.clear_errors()}},FVArrayField.prototype.disable=function(){for(var e=this,t=0;t<e.fields.length;t++){var r=e.fields[t];r.disable()}for(var t=0;t<e.add_field_buttons.length;t++){var i=e.add_field_buttons[t];i.hide()}return FVField.prototype.disable.call(this)},FVArrayField.prototype.enable=function(){for(var e=this,t=0;t<e.fields.length;t++){var r=e.fields[t];r.enable()}for(var t=0;t<e.add_field_buttons.length;t++){var i=e.add_field_buttons[t];i.show()}return FVField.prototype.enable.call(this)},FVArrayField.prototype.error=function(e){var t=this;if(t.error_message.empty(),e){if(void 0===e.error)return void console.error("No error provided");if(0===e.error)t.fields_error(e),t.hide_error();else{if(4===e.error){for(var r=$("<ul />"),i=0;i<e.errors.length;i++){var n=e.errors[i];0===n.error?t.fields_error(n):r.append($("<li />").text(n.error_message))}t.error_message.append(r)}else t.error_message.append($("<span />").text(e.error_message));t.show_error()}}else t.fields_error(null),t.hide_error()},FVArrayField.prototype.val=function(e){var t=this;if(0===arguments.length){for(var r=[],i=0;i<t.fields.length;i++){var n=t.fields[i],l=n.val();r.push(l)}return r}if(e)for(var i=0;i<e.length;i++){var n=t.fields[i];n||(n=t.new_field(i)),n.val(e[i])}return t},function(e,t,r,i){function n(t,i){this.w=e(r),this.el=e(t),this.options=e.extend({},o,i),this.init()}var l="ontouchstart"in r,a=function(){var e=r.createElement("div"),i=r.documentElement;if(!("pointerEvents"in e.style))return!1;e.style.pointerEvents="auto",e.style.pointerEvents="x",i.appendChild(e);var n=t.getComputedStyle&&"auto"===t.getComputedStyle(e,"").pointerEvents;return i.removeChild(e),!!n}(),o={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",placeClass:"dd-placeholder",group:0,threshold:20};n.prototype={init:function(){var r=this;r.reset(),r.el.data("nestable-group",this.options.group),r.placeEl=e('<div class="'+r.options.placeClass+'"/>'),e.each(this.el.find(r.options.itemNodeName),function(t,i){r.setParent(e(i))
});var i=function(t){var i=e(t.target);if(!i.hasClass(r.options.handleClass)){if(i.closest("."+r.options.noDragClass).length)return;i=i.closest("."+r.options.handleClass)}i.length&&!r.dragEl&&(r.isTouch=/^touch/.test(t.type),r.isTouch&&1!==t.touches.length||(t.preventDefault(),r.dragStart(t.touches?t.touches[0]:t)))},n=function(e){r.dragEl&&(e.preventDefault(),r.dragMove(e.touches?e.touches[0]:e))},a=function(e){r.dragEl&&(e.preventDefault(),r.dragStop(e.touches?e.touches[0]:e))};l&&(r.el[0].addEventListener("touchstart",i,!1),t.addEventListener("touchmove",n,!1),t.addEventListener("touchend",a,!1),t.addEventListener("touchcancel",a,!1)),r.el.on("mousedown",i),r.w.on("mousemove",n),r.w.on("mouseup",a)},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.hasNewRoot=!1,this.pointEl=null},setParent:function(e){e.children('[data-action="expand"]').hide()},unsetParent:function(e){e.children("[data-action]").remove(),e.children(this.options.listNodeName).remove()},dragStart:function(t){var n=this.mouse,l=e(t.target),a=l.closest(this.options.itemNodeName);this.placeEl.css("height",a.height()),this.placeEl.css("width",a.width()),this.placeEl.css("display",a.css("display")),n.offsetX=t.offsetX!==i?t.offsetX:t.pageX-l.offset().left,n.offsetY=t.offsetY!==i?t.offsetY:t.pageY-l.offset().top,n.startX=n.lastX=t.pageX,n.startY=n.lastY=t.pageY,this.dragRootEl=this.el,this.el_offset=this.el.offset(),this.dragEl=e(r.createElement(this.options.listNodeName)).addClass(this.options.dragClass),this.dragEl.css("width",a.width()),a.after(this.placeEl),a[0].parentNode.removeChild(a[0]),a.appendTo(this.dragEl),e(this.el).append(this.dragEl),this.dragEl.css({left:t.pageX-n.offsetX-this.el_offset.left,top:t.pageY-n.offsetY-this.el_offset.top})},dragStop:function(){var e=this.dragEl.children(this.options.itemNodeName).first();e[0].parentNode.removeChild(e[0]),this.placeEl.replaceWith(e),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(i){var n=this.options,l=this.mouse;this.dragEl.css({left:i.pageX-l.offsetX-this.el_offset.left,top:i.pageY-l.offsetY-this.el_offset.top}),l.lastX=l.nowX,l.lastY=l.nowY,l.nowX=i.pageX,l.nowY=i.pageY,l.distX=l.nowX-l.lastX,l.distY=l.nowY-l.lastY,l.lastDirX=l.dirX,l.lastDirY=l.dirY,l.dirX=0===l.distX?0:l.distX>0?1:-1,l.dirY=0===l.distY?0:l.distY>0?1:-1;var o=Math.abs(l.distX)>Math.abs(l.distY)?1:0;if(!l.moving)return l.dirAx=o,void(l.moving=!0);l.dirAx!==o?(l.distAxX=0,l.distAxY=0):(l.distAxX+=Math.abs(l.distX),0!==l.dirX&&l.dirX!==l.lastDirX&&(l.distAxX=0),l.distAxY+=Math.abs(l.distY),0!==l.dirY&&l.dirY!==l.lastDirY&&(l.distAxY=0)),l.dirAx=o;if(a||(this.dragEl[0].style.visibility="hidden"),this.pointEl=e(r.elementFromPoint(i.pageX-r.body.scrollLeft,i.pageY-(t.pageYOffset||r.documentElement.scrollTop))),this.pointEl.hasClass(n.itemClass)||(this.pointEl=this.pointEl.closest("."+n.itemClass)),a||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(n.handleClass))this.pointEl=this.pointEl.closest("."+n.itemClass);else if(!this.pointEl.length||!this.pointEl.hasClass(n.itemClass))return;var s=this.pointEl.closest("."+n.rootClass);if(n.group===s.data("nestable-group")){var d=(i.pageY-this.pointEl.offset().top,i.pageY-this.pointEl.offset().top,i.pageX<this.pointEl.offset().left+this.pointEl.width()/2),u=i.pageY<this.pointEl.offset().top+this.pointEl.height()/2;"block"===this.pointEl.css("display")?u?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl):u&&d?this.pointEl.before(this.placeEl):u||d||this.pointEl.after(this.placeEl)}}},e.fn.nestable=function(t){var r=this,i=this;return r.each(function(){var r=e(this).data("nestable");r?"string"==typeof t&&"function"==typeof r[t]&&(i=r[t]()):(e(this).data("nestable",new n(this,t)),e(this).data("nestable-id",(new Date).getTime()))}),i||r}}(window.jQuery||window.Zepto,window,document),fieldval_ui_extend(FVKeyValueField,FVField),FVKeyValueField.prototype.create_add_field_button=function(){var e=this,t=$("<button />").addClass("fv_add_field_button").text("+").on(FVForm.button_event,function(t){t.preventDefault(),e.new_field(e.fields.length)});return e.add_field_buttons.push(t),t},FVKeyValueField.prototype.new_field=function(){throw new Error("FVKeyValueField.new_field must be overriden to create fields")},FVKeyValueField.prototype.add_field=function(e,t){var r=this;t.in_key_value(r,function(){r.remove_field(t)}),t.element.appendTo(r.fields_element),r.fields.push(t),t.parent=r,r.input_holder.nestable("init"),t.name_val(""),r.is_disabled&&t.disable()},FVKeyValueField.prototype.change_key_name=function(e,t,r){var i=this;if(void 0!==e){var n=i.keys[e];if(n!==r)throw new Error("Old key name does not match this field ",e);delete i.keys[e]}null===t&&(t="");for(var l=t,a=2;void 0!==i.keys[l];)l=t+"_"+a++;return i.keys[l]=r,l},FVKeyValueField.prototype.remove_field=function(e){var t,r,i=this;if("string"==typeof e){for(var n=0;n<i.fields.length;n++)if(i.fields[n].name_val()===e){t=i.fields[n],r=n;break}}else{if(!(e instanceof FVField))throw new Error("FVKeyValueField.remove_field only accepts strings or FVField instances");for(var n in i.fields)if(i.fields.hasOwnProperty(n)&&i.fields[n]===e){t=i.fields[n],r=n;break}}t&&(t.remove(!0),i.fields.splice(r,1))},FVKeyValueField.prototype.error=function(e){FVKeyValueField.superClass.error.call(this,e)},FVKeyValueField.prototype.fields_error=function(e){var t=this;if(e){var r=e.invalid||{},i=e.missing||{},n=e.unrecognized||{};for(var l in t.keys){var a=t.keys[l],o=r[l]||i[l]||n[l]||null;a.error(o)}}else for(var l in t.keys){var a=t.keys[l];a.error(null)}},FVKeyValueField.prototype.clear_errors=function(){for(var e=this,t=0;t<e.fields.length;t++){var r=e.fields[t];r.clear_errors()}},FVKeyValueField.prototype.disable=function(){for(var e=this,t=0;t<e.fields.length;t++){var r=e.fields[t];r.disable()}for(var t=0;t<e.add_field_buttons.length;t++){var i=e.add_field_buttons[t];i.hide()}return FVField.prototype.disable.call(this)},FVKeyValueField.prototype.enable=function(){for(var e=this,t=0;t<e.fields.length;t++){var r=e.fields[t];r.enable()}for(var t=0;t<e.add_field_buttons.length;t++){var i=e.add_field_buttons[t];i.show()}return FVField.prototype.enable.call(this)},FVKeyValueField.prototype.error=function(e){var t=this;if(t.error_message.empty(),e){if(void 0===e.error)return void console.error("No error provided");if(0===e.error)t.fields_error(e),t.hide_error();else{if(4===e.error){for(var r=$("<ul />"),i=0;i<e.errors.length;i++){var n=e.errors[i];0===n.error?t.fields_error(n):r.append($("<li />").text(n.error_message))}t.error_message.append(r)}else t.error_message.append($("<span />").text(e.error_message));t.show_error()}}else t.fields_error(null),t.hide_error()},FVKeyValueField.prototype.val=function(e){var t=this;if(0===arguments.length){var r={};for(var i in t.keys){var n=t.keys[i];if(n.output_flag!==!1){var l=n.val();r[i]=l}}return r}if(e)for(var i in e)if(e.hasOwnProperty(i)){var n=t.fields[i];n||(n=t.new_field(i)),n.val(e[i]),n.name_val(i)}return t},fieldval_ui_extend(FVForm,FVObjectField),FVForm.button_event="click",FVForm.is_mobile=/android|webos|iphone|ipad|ipod|blackberry|iemobile|nokia|series40|x11|opera mini/i.test(navigator.userAgent.toLowerCase()),$.tap&&(FVForm.button_event="tap"),FVForm.prototype.on_submit=function(e){var t=this;return t.submit_callbacks.push(e),t},FVForm.prototype.submit=function(){for(var e=this,t=e.val(),r=0;r<e.submit_callbacks.length;r++){var i=e.submit_callbacks[r];i(t)}return t},"undefined"!=typeof module&&(module.exports={fieldval:FieldVal,basicval:BasicVal,dateval:DateVal,rules:ValidationRule});